#!/bin/bash

# Local & Public IP
LOCAL_IP=$(hostname -I | awk '{print $1}')
PUBLIC_IP=$(curl -s ifconfig.me)

# Tailscale IP
if command -v tailscale &> /dev/null; then
    TAILSCALE_IP=$(tailscale ip -4 2>/dev/null | head -n1)
fi

# ZeroTier IP
if command -v zerotier-cli &> /dev/null; then
    ZEROTIER_IP=$(sudo zerotier-cli listnetworks 2>/dev/null | awk 'NR>1 {print $9}' | head -n1)
fi

# Other Network Interfaces (excluding lo, eth0, wlan0, tailscale, zerotier)
OTHER_INTERFACES=$(ip -4 addr show | grep -E '^[0-9]+:' | awk -F': ' '{print $2}' | grep -vE '^(lo|eth0|wlan0|tailscale|zt)' | head -3)
declare -A IFACE_IPS
for iface in $OTHER_INTERFACES; do
    iface_ip=$(ip -4 addr show $iface 2>/dev/null | grep inet | awk '{print $2}' | cut -d'/' -f1 | head -n1)
    if [ -n "$iface_ip" ]; then
        IFACE_IPS["$iface"]="$iface_ip"
    fi
done

# CPU Temp
CPU_TEMP=$(sensors | awk '/^Package id 0:/ {print $4}')

# CPU Usage
CPU_USE=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8"%"}')

# Memory Usage
MEM_USE=$(free -m | awk '/Mem:/ {printf "%dMB / %dMB (%.1f%%)", $3, $2, $3*100/$2}')

# Intel iGPU Usage (instant snapshot)
if command -v intel_gpu_top &> /dev/null; then
    GPU_USE=$(timeout 0.5 intel_gpu_top -J 2>/dev/null | jq -r '.engines[] | select(.class=="Render/3D") | .busy' | head -n1)
    GPU_USE="${GPU_USE:-0}%"
else
    GPU_USE="N/A"
fi

# Disk Usage
DISK_USE=$(df -h / | awk 'NR==2 {print $3 " / " $2 " (" $5 ")"}')

# Ubuntu Version
UBUNTU_VERSION=$(lsb_release -d | cut -f2)

# Updates Available
UPDATES=$(apt list --upgradable 2>/dev/null | grep -c upgradable)
if [ "$UPDATES" -eq 0 ]; then
    UPDATES_COLOR="\e[1;31m$UPDATES\e[1;37m"
else
    UPDATES_COLOR="\e[1;32m$UPDATES\e[1;37m"
fi

# OS Updates Available
OS_UPDATES=$(apt list --upgradable 2>/dev/null | grep -E "(ubuntu-|linux-|base-files)" | wc -l)
if [ "$OS_UPDATES" -eq 0 ]; then
    OS_UPDATE_STATUS="\e[1;32mUp to date\e[1;37m"
else
    OS_UPDATE_STATUS="\e[1;31m$OS_UPDATES updates available\e[1;37m"
fi

# DietPi-style banner
echo -e "\e[90m─────────────────────────────────────────────────────────────────────────────\e[0m"
echo -e "\e[1;33m $UBUNTU_VERSION \e[0m| \e[90m$(hostname)\e[0m"
echo -e "\e[90m─────────────────────────────────────────────────────────────────────────────\e[0m"
echo -e " \e[38;5;154m●\e[0m Uptime............: \e[1m$(uptime -p | sed 's/up //')\e[0m"
echo -e " \e[38;5;154m●\e[0m CPU temp..........: \e[1m$CPU_TEMP\e[0m"
echo -e " \e[38;5;154m●\e[0m CPU usage.........: \e[1m$CPU_USE\e[0m"
echo -e " \e[38;5;154m●\e[0m Memory usage......: \e[1m$MEM_USE\e[0m"
echo -e " \e[38;5;154m●\e[0m GPU usage.........: \e[1m$GPU_USE\e[0m"
echo -e " \e[38;5;154m●\e[0m Disk usage (/)....: \e[1m$DISK_USE\e[0m"
echo -e " \e[38;5;154m●\e[0m Local IP..........: \e[1m$LOCAL_IP\e[0m"
echo -e " \e[38;5;154m●\e[0m Public IP.........: \e[1m$PUBLIC_IP\e[0m"
if [ -n "$TAILSCALE_IP" ]; then
    echo -e " \e[38;5;154m●\e[0m Tailscale IP......: \e[1m$TAILSCALE_IP\e[0m"
fi
if [ -n "$ZEROTIER_IP" ]; then
    echo -e " \e[38;5;154m●\e[0m ZeroTier IP.......: \e[1m$ZEROTIER_IP\e[0m"
fi
# Display other interfaces
for iface in $OTHER_INTERFACES; do
    if [ -n "${IFACE_IPS[$iface]}" ]; then
        printf " \e[38;5;154m●\e[0m %-14s: \e[1m%s\e[0m\n" "${iface} IP" "${IFACE_IPS[$iface]}"
    fi
done
printf " \e[38;5;154m●\e[0m Updates...........: %b packages available\n" "$UPDATES_COLOR"
printf " \e[38;5;154m●\e[0m OS Status.........: %b\n" "$OS_UPDATE_STATUS"
echo -e "\e[90m─────────────────────────────────────────────────────────────────────────────\e[0m"

# Show update command if updates are available
if [ "$UPDATES" -gt 0 ] || [ "$OS_UPDATES" -gt 0 ]; then
    echo -e "\e[1;33m⚠ Updates available! Run: \e[1;36msudo apt update && sudo apt upgrade\e[0m"
fi